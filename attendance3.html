<!doctype html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Attendance Form with Persistent Login</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px 10px;
      background-color: #f4f4f4;
    }
    .container {
      background: white;
      padding: 20px;
      max-width: 600px;
      margin: 20px auto;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    h2 {
      text-align: center;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      box-sizing: border-box;
    }
    button {
      margin-top: 20px;
      padding: 10px;
      width: 100%;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    #clearBtn {
      background-color: #f44336;
    }
    #clearBtn:hover {
      background-color: #d32f2f;
    }
    .output {
      margin-top: 20px;
      padding: 10px;
      border-radius: 4px;
      white-space: pre-wrap;
      display: none;
    }
    .output.show {
      display: block;
    }
    .error {
      background: #ffebee;
      color: #c62828;
    }
    .success {
      background: #e8f5e9;
      color: #2e7d32;
    }
    iframe {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #subjectDisplay {
      margin-top: 8px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<!-- Password Login -->
<div id="passwordPrompt" class="container" style="display:none;">
  <h2>Enter Password</h2>
  <input type="password" id="passwordInput" placeholder="Enter password" />
  <button onclick="checkPassword()">Enter</button>
  <div id="passwordError" style="color: red; display: none; margin-top: 10px;">
    Incorrect password. Try again.
  </div>
</div>

<!-- Attendance Form -->
<div class="container" id="formContainer" style="display:none;">
  <h2>Teacher Attendance Form</h2>
  <form id="attendanceForm">
    <label for="englishDate">Date (English):</label>
    <input type="date" id="englishDate" required />

    <label for="teacher">Teacher:</label>
    <select id="teacher" required>
      <option value="">--Select--</option>
      <option value="Harihar Poudel">Harihar Poudel</option>
      <option value="Sudip Poudel">Sudip Poudel</option>
      <option value="Hari Chhantyal">Hari Chhantyal</option>
      <option value="Pashupatinath Dhakal">Pashupatinath Dhakal</option>
      <option value="Debraj Sharma">Debraj Sharma</option>
      <option value="Prem G.C">Prem G.C</option>
    </select>

    <div id="subjectDisplay"></div>

    <label for="classIn">Class In Time:</label>
    <input type="time" id="classIn" required />

    <label for="classOut">Class Out Time:</label>
    <input type="time" id="classOut" required />

    <label for="notes">Notes:</label>
    <input type="text" id="notes" />

    <button type="submit" id="submitBtn">Submit Attendance</button>
    <button type="button" id="clearBtn">Clear Saved Data & Logout</button>
  </form>

  <div class="output" id="output"></div>

  <!-- Google Sheet Embed -->
  <div style="margin-top: 20px;">
    <iframe
      src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTT9TKLMcFr1bws9B-bJn93AitVw6kPmPv5avAFdMI65MlvI40xvaBIc57wGOLenr6KLayRtsihWhXS/pubhtml?gid=0&single=true&widget=true&headers=false"
      height="350"
      allowfullscreen>
    </iframe>
  </div>
</div>

<script>
  const teacherSubjectMap = {
    "Harihar Poudel": "Data Base Management System",
    "Sudip Poudel": "System Analyst & Design",
    "Hari Chhantyal": "Operating System",
    "Pashupatinath Dhakal": "Fundamental of Curriculum",
    "Debraj Sharma": "Numerical Analysis",
    "Prem G.C": "Leadership Skills",
  };

  function checkPassword() {
    const input = document.getElementById("passwordInput").value.trim();
    if (input === "1234") {
      localStorage.setItem("isLoggedIn", "true");
      showForm();
    } else {
      document.getElementById("passwordError").style.display = "block";
    }
  }

  function showForm() {
    document.getElementById("passwordPrompt").style.display = "none";
    document.getElementById("formContainer").style.display = "block";
    loadSavedData();
  }

  function showPasswordPrompt() {
    document.getElementById("formContainer").style.display = "none";
    document.getElementById("passwordPrompt").style.display = "block";
    document.getElementById("passwordInput").value = "";
    document.getElementById("passwordError").style.display = "none";
  }

  function setTodayDate() {
    document.getElementById("englishDate").value = new Date().toISOString().split("T")[0];
  }

  function showOutput(msg, isError = false) {
    const output = document.getElementById("output");
    output.textContent = msg;
    output.className = `output show ${isError ? "error" : "success"}`;
  }

  function hideOutput() {
    const output = document.getElementById("output");
    output.className = "output";
    output.textContent = "";
  }

  function formatTimeTo12Hour(timeStr) {
    const [hour, minute] = timeStr.split(":");
    const h = parseInt(hour);
    const ampm = h >= 12 ? "PM" : "AM";
    const hour12 = h % 12 || 12;
    return `${hour12}:${minute} ${ampm}`;
  }

  function validateTimes(classIn, classOut) {
    if (!classIn || !classOut) return false;
    return new Date(`1970-01-01T${classOut}`) > new Date(`1970-01-01T${classIn}`);
  }

  function saveData() {
    const data = {
      englishDate: document.getElementById("englishDate").value,
      teacher: document.getElementById("teacher").value,
      classIn: document.getElementById("classIn").value,
      classOut: document.getElementById("classOut").value,
      notes: document.getElementById("notes").value,
    };
    localStorage.setItem("pendingAttendance", JSON.stringify(data));
  }

  function loadSavedData() {
    const saved = JSON.parse(localStorage.getItem("pendingAttendance") || "{}");
    document.getElementById("englishDate").value = saved.englishDate || new Date().toISOString().split("T")[0];
    document.getElementById("teacher").value = saved.teacher || "";
    document.getElementById("classIn").value = saved.classIn || "";
    document.getElementById("classOut").value = saved.classOut || "";
    document.getElementById("notes").value = saved.notes || "";

    const subject = teacherSubjectMap[saved.teacher] || "";
    document.getElementById("subjectDisplay").textContent = subject ? `📘 Subject: ${subject}` : "";

    if (saved.teacher) {
      showOutput("📌 You have unsaved attendance. Please submit.");
    }
  }

  document.getElementById("teacher").addEventListener("change", function () {
    const subject = teacherSubjectMap[this.value] || "";
    document.getElementById("subjectDisplay").textContent = subject ? `📘 Subject: ${subject}` : "";
    saveData();
  });

  document.getElementById("attendanceForm").addEventListener("input", () => {
    saveData();
    if (document.getElementById("output").classList.contains("show")) {
      setTimeout(hideOutput, 2000);
    }
  });

  let isSubmitting = false;

  document.getElementById("attendanceForm").addEventListener("submit", (e) => {
    e.preventDefault();
    if (isSubmitting) return;

    const englishDate = document.getElementById("englishDate").value;
    const teacher = document.getElementById("teacher").value;
    const classIn = document.getElementById("classIn").value;
    const classOut = document.getElementById("classOut").value;
    const notes = document.getElementById("notes").value;
    const subject = teacherSubjectMap[teacher] || "";

    if (!validateTimes(classIn, classOut)) {
      showOutput("❌ Class out time must be after class in time!", true);
      return;
    }

    const inTime = new Date(`1970-01-01T${classIn}`);
    const outTime = new Date(`1970-01-01T${classOut}`);
    const duration = `${Math.round((outTime - inTime) / 60000)} min`;

    const data = {
      englishDate, teacher, subject,
      classIn: formatTimeTo12Hour(classIn),
      classOut: formatTimeTo12Hour(classOut),
      duration, notes,
    };

    const submitBtn = document.getElementById("submitBtn");
    submitBtn.disabled = true;
    submitBtn.textContent = "Submitting...";
    isSubmitting = true;
    showOutput("⏳ Submitting attendance...");

    fetch("https://script.google.com/macros/s/AKfycbyUWG9EsvNDDQzaT4F9DpAiz9seXEEYWBZqzYDGD3FmGQ3E-zwKkzkZ2ZEHdHp01PI/exec", {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify(data),
      headers: { "Content-Type": "application/json" },
    })
    .then(() => {
      showOutput("✅ Attendance saved successfully!");
      document.getElementById("attendanceForm").reset();
      document.getElementById("subjectDisplay").textContent = "";
      setTodayDate();
      localStorage.removeItem("pendingAttendance");
    })
    .catch((err) => {
      console.error(err);
      showOutput("❌ Error saving attendance. Try again.", true);
    })
    .finally(() => {
      submitBtn.disabled = false;
      submitBtn.textContent = "Submit Attendance";
      isSubmitting = false;
    });
  });

  document.getElementById("clearBtn").addEventListener("click", () => {
    localStorage.removeItem("pendingAttendance");
    localStorage.removeItem("isLoggedIn");
    document.getElementById("attendanceForm").reset();
    setTodayDate();
    document.getElementById("subjectDisplay").textContent = "";
    hideOutput();
    showPasswordPrompt();
  });

  // Initial Load
  window.addEventListener("load", () => {
    localStorage.getItem("isLoggedIn") === "true" ? showForm() : showPasswordPrompt();
    setTodayDate();
  });
</script>

</body>
  </html>
