<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Teacher Attendance Form with Persistent Login</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 40px;
        background-color: #f4f4f4;
      }
      .container {
        background: white;
        padding: 20px;
        max-width: 600px;
        margin: auto;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      h2 {
        text-align: center;
      }
      label {
        display: block;
        margin-top: 10px;
      }
      input,
      select {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        box-sizing: border-box;
      }
      button {
        margin-top: 20px;
        padding: 10px;
        width: 100%;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
      }
      button:hover {
        background-color: #45a049;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      #clearBtn {
        background-color: #f44336;
      }
      #clearBtn:hover {
        background-color: #d32f2f;
      }
      .output {
        margin-top: 20px;
        background: #e8f5e9;
        padding: 10px;
        border-radius: 4px;
        white-space: pre-wrap;
        display: none;
      }
      .output.show {
        display: block;
      }
      .error {
        background: #ffebee;
        color: #c62828;
      }
      .success {
        background: #e8f5e9;
        color: #2e7d32;
      }
    </style>
  </head>
  <body>
    <!-- Password Prompt -->
    <div id="passwordPrompt" class="container" style="display:none;">
      <h2>Enter Password</h2>
      <input type="password" id="passwordInput" placeholder="Enter password" />
      <button onclick="checkPassword()">Enter</button>
      <div id="passwordError" style="color: red; display: none; margin-top: 10px;">
        Incorrect password. Try again.
      </div>
    </div>

    <!-- Attendance Form Container -->
    <div class="container" id="formContainer" style="display:none;">
      <h2>Teacher Attendance Form</h2>
      <form id="attendanceForm">
        <label for="englishDate">Date (English):</label>
        <input type="date" id="englishDate" required />

        <label for="teacher">Teacher:</label>
        <select id="teacher" required>
          <option value="">--Select--</option>
          <option value="Harihar Poudel">Harihar Poudel</option>
          <option value="Sudip Poudel">Sudip Poudel</option>
          <option value="Hari Chhantyal">Hari Chhantyal</option>
          <option value="Pashupatinath Dhakal">Pashupatinath Dhakal</option>
          <option value="Debraj Sharma">Debraj Sharma</option>
          <option value="Prem G.C">Prem G.C</option>
        </select>

        <label for="subject">Subject:</label>
        <input type="text" id="subject" readonly required />

        <label for="classIn">Class In Time:</label>
        <input type="time" id="classIn" />

        <label for="classOut">Class Out Time:</label>
        <input type="time" id="classOut" />

        <label for="notes">Notes:</label>
        <input type="text" id="notes" />

        <button type="submit" id="submitBtn">Submit Attendance</button>
        <button type="button" id="clearBtn">Clear Saved Data & Logout</button>
      </form>

      <div class="output" id="output"></div>

      <!-- Embedded Google Sheet -->
      <div style="max-width: 800px; margin: 20px auto; overflow-x: auto;">
        <iframe
          src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTT9TKLMcFr1bws9B-bJn93AitVw6kPmPv5avAFdMI65MlvI40xvaBIc57wGOLenr6KLayRtsihWhXS/pubhtml?gid=0&amp;single=true&amp;widget=true&amp;headers=false"
          width="100%"
          height="350"
          style="border: 1px solid #ccc; border-radius: 8px; display: block;"
          allowfullscreen>
        </iframe>
      </div>
    </div>

    <script>
      // Password protection and login state handling
      function checkPassword() {
        const input = document.getElementById("passwordInput").value.trim();
        if (input === "1234") {
          localStorage.setItem("isLoggedIn", "true");
          showForm();
          document.getElementById("passwordError").style.display = "none";
        } else {
          document.getElementById("passwordError").style.display = "block";
        }
      }

      function showForm() {
        document.getElementById("passwordPrompt").style.display = "none";
        document.getElementById("formContainer").style.display = "block";
        loadSavedData();
      }

      function showPasswordPrompt() {
        document.getElementById("formContainer").style.display = "none";
        document.getElementById("passwordPrompt").style.display = "block";
        document.getElementById("passwordInput").value = "";
        document.getElementById("passwordError").style.display = "none";
      }

      window.addEventListener("load", () => {
        const loggedIn = localStorage.getItem("isLoggedIn");
        if (loggedIn === "true") {
          showForm();
        } else {
          showPasswordPrompt();
        }
      });

      const teacherSubjectMap = {
        "Harihar Poudel": "Data Base Management System",
        "Sudip Poudel": "System Analyst & Design",
        "Hari Chhantyal": "Operating System",
        "Pashupatinath Dhakal": "Fundamental of Curriculum",
        "Debraj Sharma": "Numerical Analysis",
        "Prem G.C": "Leadership Skills",
      };

      function setTodayDate() {
        document.getElementById("englishDate").value = new Date().toISOString().split("T")[0];
      }

      setTodayDate();

      document.getElementById("teacher").addEventListener("change", function () {
        const subject = teacherSubjectMap[this.value] || "";
        document.getElementById("subject").value = subject;
        saveData();
      });

      function saveData() {
        const data = {
          englishDate: document.getElementById("englishDate").value,
          teacher: document.getElementById("teacher").value,
          subject: document.getElementById("subject").value,
          classIn: document.getElementById("classIn").value,
          classOut: document.getElementById("classOut").value,
          notes: document.getElementById("notes").value,
        };
        localStorage.setItem("pendingAttendance", JSON.stringify(data));
      }

      function loadSavedData() {
        const saved = localStorage.getItem("pendingAttendance");
        if (saved) {
          const data = JSON.parse(saved);
          document.getElementById("englishDate").value = data.englishDate || new Date().toISOString().split("T")[0];
          document.getElementById("teacher").value = data.teacher || "";
          document.getElementById("subject").value = data.subject || "";
          document.getElementById("classIn").value = data.classIn || "";
          document.getElementById("classOut").value = data.classOut || "";
          document.getElementById("notes").value = data.notes || "";
          showOutput("ðŸ“Œ You have unsaved attendance. Please complete and submit.");
        } else {
          setTodayDate();
        }
      }

      function formatTimeTo12Hour(timeStr) {
        if (!timeStr) return "";
        const [hour, minute] = timeStr.split(":");
        const h = parseInt(hour);
        const ampm = h >= 12 ? "PM" : "AM";
        const hour12 = h % 12 || 12;
        return `${hour12}:${minute} ${ampm}`;
      }

      function validateTimes(classIn, classOut) {
        if (!classIn || !classOut) return false;
        const inTime = new Date(`1970-01-01T${classIn}:00`);
        const outTime = new Date(`1970-01-01T${classOut}:00`);
        return outTime > inTime;
      }

      function showOutput(message, isError = false) {
        const output = document.getElementById("output");
        output.textContent = message;
        output.className = `output show ${isError ? "error" : "success"}`;
      }

      function hideOutput() {
        const output = document.getElementById("output");
        output.className = "output";
        output.textContent = "";
      }

      document.getElementById("attendanceForm").addEventListener("input", () => {
        saveData();
        if (document.getElementById("output").classList.contains("show")) {
          setTimeout(hideOutput, 3000);
        }
      });

      document.getElementById("attendanceForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const englishDate = document.getElementById("englishDate").value;
        const teacher = document.getElementById("teacher").value;
        const subject = document.getElementById("subject").value;
        const classIn = document.getElementById("classIn").value;
        const classOut = document.getElementById("classOut").value;
        const notes = document.getElementById("notes").value;

        if (!validateTimes(classIn, classOut)) {
          showOutput("âŒ Error: Class out time must be after class in time!", true);
          return;
        }

        const inTime = new Date(`1970-01-01T${classIn}:00`);
        const outTime = new Date(`1970-01-01T${classOut}:00`);
        const duration = Math.round((outTime - inTime) / 60000);

        const data = {
          englishDate,
          teacher,
          subject,
          classIn: formatTimeTo12Hour(classIn),
          classOut: formatTimeTo12Hour(classOut),
          duration: `${duration} min`,
          notes,
        };

        const submitBtn = document.getElementById("submitBtn");
        submitBtn.disabled = true;
        submitBtn.textContent = "Submitting...";
        showOutput("â³ Submitting attendance data...");

        fetch(
          "https://script.google.com/macros/s/AKfycbyUWG9EsvNDDQzaT4F9DpAiz9seXEEYWBZqzYDGD3FmGQ3E-zwKkzkZ2ZEHdHp01PI/exec",
          {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify(data),
            headers: {
              "Content-Type": "application/json",
            },
          }
        )
          .then(() => {
            showOutput("âœ… Attendance saved to Google Sheet successfully!");
            document.getElementById("attendanceForm").reset();
            setTodayDate();
            localStorage.removeItem("pendingAttendance");
          })
          .catch((err) => {
            console.error("Error details:", err);
            showOutput("âŒ Error saving data. Please try again or contact administrator.", true);
          })
          .finally(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = "Submit Attendance";
          });
      });

      document.getElementById("clearBtn").addEventListener("click", () => {
        localStorage.removeItem("pendingAttendance");
        localStorage.removeItem("isLoggedIn");
        document.getElementById("attendanceForm").reset();
        setTodayDate();
        hideOutput();
        showPasswordPrompt();
      });
    </script>
  </body>
</html>
